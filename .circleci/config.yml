version: 2
jobs:
  checkout:
    machine: true
    working_directory: ~/go/src/github.com/docker/compose-on-kubernetes
    steps:
      - checkout
      - persist_to_workspace:
          root: ~/go/
          paths:
            - 'src'
  build:
    machine: true
    working_directory: ~/go/src/github.com/docker/compose-on-kubernetes
    steps:
      - attach_workspace:
          at: ~/go
      - run:
          name: Build the installer
          command: |
            docker run --rm -it \
              -v ~/go:/go \
              jdrouet/gocker \
              make IMAGE_REPO_PREFIX=docker/kube-compose- bin/installer
      - persist_to_workspace:
          root: ~/go/
          paths:
            - 'src'
  e2e:
    machine: true
    working_directory: ~/go/src/github.com/docker/compose-on-kubernetes
    steps:
      - attach_workspace:
          at: ~/go
      - run:
          name: Try to run the script
          command: |
            docker run --rm -it \
              --name turkey-filling-1.11.5 \
              -v ~/go/src:/go/src \
              jdrouet/gocker:latest \
              ls /go/src
      - run:
          name: Start the cluster
          command: ./scripts/e2e-cluster.sh create
          environment:
            - KUBE_VERSION: 1.11.5
            - CLUSTER_NAME: testing
      - persist_to_workspace:
          root: ~/go/
          paths:
            - 'src'

workflows:
  version: 2
  build:
    jobs:
      - checkout
      - build:
          requires:
            - checkout
      - e2e:
          requires:
            - build
